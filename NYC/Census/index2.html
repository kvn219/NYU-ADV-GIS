<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .tracts {
        fill: #fff;
        stroke: lightblue;
        stroke-width: 1px;
    }

    div.tooltip {
        position: absolute;
        background-color: white;
        border: 1px solid black;
        color: black;
        font-weight: bold;
        padding: 4px 8px;
        display: none;
    }

    path {
        stroke-width: 1px;
        stroke: white;
        fill: steelblue;
        cursor: pointer;
    }

    path:hover,
    path.highlighted {
        fill: tomato;
    }

    .schools {
        fill: red;
        stroke: #fff;
        opacity: 0.7;
    }

</style>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script>
        var width = 1000,
            height = 750;

        var tooltip = d3.select("body").append("div").attr("class", "tooltip");

        var centered;


        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var projection = d3.geo.mercator()
            .scale(6000)
            .center([-75.83492192664968, 42.78911936294013]) //projection center
            .translate([width / 2, height / 2]) //translate to center the map in view

        var path = d3.geo.path()
            .projection(projection);

        var features = svg.append("g")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "features");


        // load and display the World
        d3.json("cb_2014_36_tract_500k.topojson", function(error, ny) {

            // load and display the cities
            d3.json('schools.geojson', function(error, schools) {

                // ny.objects.collection.type = ny.objects.collection.geometries
                //     .filter(function(d) {
                //         return (d.id / 10000 | 0) !== 99;
                //     });
                // svg.append("g")
                console.log(ny);
                features.selectAll("path")
                    .data(topojson.feature(ny, ny.objects.collection).features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr('class', 'tracts')
                    .on("click", clicked);
                svg.selectAll('.schools')
                    .data(schools.features)
                    .enter()
                    .append('path')
                    .attr('d', path.pointRadius(2))
                    .attr('class', 'schools')
                    .on("mouseover", showTooltip)
                    .on("mousemove", moveTooltip)
                    .on("mouseout", hideTooltip)
            });
        });

        function clicked(d, i) {

            //Add any other onClick events here

            var x, y, k;

            if (d && centered !== d) {
                // Compute the new map center and scale to zoom to
                var centroid = path.centroid(d);
                var b = path.bounds(d);
                x = centroid[0];
                y = centroid[1];
                k = .8 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height);
                centered = d
            } else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }

            // Highlight the new feature
            features.selectAll("path")
                .classed("highlighted", function(d) {
                    return d === centered;
                })
                .style("stroke-width", 1 / k + "px"); // Keep the border width constant

            //Zoom and re-center the map
            //Uncomment .transition() and .duration() to make zoom gradual
            features
                .transition()
                .duration(500)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")");


            d3.selectAll("circle")
                .transition()
                .duration(750)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")

        }


        //Position of the tooltip relative to the cursor
        var tooltipOffset = {
            x: 5,
            y: -25
        };

        //Create a tooltip, hidden at the start
        function showTooltip(d) {
            moveTooltip();

            tooltip.style("display", "block")
                .text(d.properties.NAME);
        }

        //Move the tooltip to track the mouse
        function moveTooltip() {
            tooltip.style("top", (d3.event.pageY + tooltipOffset.y) + "px")
                .style("left", (d3.event.pageX + tooltipOffset.x) + "px");
        }

        //Create a tooltip, hidden at the start
        function hideTooltip() {
            tooltip.style("display", "none");
        }

    </script>
